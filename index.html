<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Combined Analysis: Climate, CO₂ & Agricultural Data</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f8f9fa;
      margin: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .chart-container {
      margin: 30px auto;
      text-align: center;
    }
    svg {
      background: white;
      border: 1px solid #ddd;
      margin-bottom: 40px;
    }
    #climate-controls {
      text-align: center;
      margin-bottom: 10px;
    }
    .legend {
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>Combined Analysis: Climate, CO₂ & Agricultural Data</h1>
  
  <!-- 1. Climate Analysis: Interactive Scatter Plot -->
  <section id="climate-analysis" class="chart-container">
    <h2>Climate Analysis</h2>
    <div id="climate-controls">
      <label>Select Climate Factor for X-axis:</label>
      <select id="climate-factor">
        <option value="SolarIrradiance">Solar Irradiance</option>
        <option value="CloudCover">Cloud Cover</option>
        <option value="Precipitation">Precipitation</option>
      </select>
      &nbsp;&nbsp;
      <label>Select Y-axis:</label>
      <input type="radio" name="climate-y" value="Temperature" checked> Temperature
      <input type="radio" name="climate-y" value="VegetationIndex"> Vegetation Index
    </div>
    <svg id="climate-chart" width="800" height="500"></svg>
  </section>
  
  <!-- 2. Agriculture Analysis: Dual-Axis Line Chart -->
  <section id="agriculture-analysis" class="chart-container">
    <h2>Agriculture Analysis (Dual-Axis Line Chart)</h2>
    <svg id="agriculture-chart" width="800" height="500"></svg>
  </section>
  
  <!-- 3. Timeline Analysis: Combined Normalized Trends (if common years exist) -->
  <section id="timeline-analysis" class="chart-container">
    <h2>Timeline Analysis (Normalized Values)</h2>
    <svg id="timeline-chart" width="1000" height="500"></svg>
    <div id="timeline-msg" style="text-align:center; color:red;"></div>
  </section>
  
  <script>
    /***** DATA LOADING & PREPARATION *****/
    // CSV URLs (provided)
    const CLIMATE_CSV_URL = "https://gist.githubusercontent.com/mystrycodes/0e4190865121859997eec1fc2d5b4dcd/raw/d10453ccf854feb48e10319eb8025a973f938abe/climate.csv";
    const CROP_CSV_URL = "https://gist.githubusercontent.com/mystrycodes/3d3cf36c88a4f23a187cb4e12a835e10/raw/5aebb1fc334be000f4b756db6d5c83adf71e89ab/CropProduction.csv";
    const CO2_CSV_URL  = "https://gist.githubusercontent.com/mystrycodes/f3e133db6c35f1f7180296e872441fe4/raw/4c5bc29c4c18f3510bead103c2188d5a919f066d/Co2emmission.csv";
    
    let climateData = null;
    let cropData = null;
    let co2Data = null;
    
    // Load all three datasets concurrently.
    Promise.all([
      d3.csv(CLIMATE_CSV_URL, d => ({
        Year: +d.Year,
        SolarIrradiance: +d.SolarIrradiance,
        CloudCover: +d.CloudCover,
        Precipitation: +d.Precipitation,
        Temperature: +d.Temperature,
        VegetationIndex: +d.VegetationIndex
      })),
      d3.csv(CROP_CSV_URL, d => ({
          year: +d.TIME,
          production: +d.Value,
          country: d.Country
      })).then(data => {
          // Accept rows that mention either "United States" or "USA"
          return data.filter(d => d.country && (d.country.includes("United States") || d.country.includes("USA")) && !isNaN(d.year) && !isNaN(d.production));
      }),
      d3.csv(CO2_CSV_URL, d => ({
          year: +d.Year,
          co2: +d.total_emission,
          country: d.Country
      })).then(data => {
          return data.filter(d => d.country && (d.country.includes("United States") || d.country.includes("USA")) && !isNaN(d.year) && !isNaN(d.co2));
      })
    ]).then(function([climate, crop, co2]) {
      climateData = climate;
      cropData = crop;
      co2Data = co2;
      
      console.log("Climate Data:", climateData.length, "rows");
      console.log("Crop Data:", cropData.length, "rows");
      console.log("CO₂ Data:", co2Data.length, "rows");
      
      // Draw charts
      drawClimateChart();
      drawAgricultureChart();
      drawTimelineChart();
    }).catch(error => {
      console.error("Error loading data:", error);
    });
    
    /***** 1. CLIMATE ANALYSIS CHART *****/
    function drawClimateChart() {
      const svg = d3.select("#climate-chart");
      const svgWidth = +svg.attr("width");
      const svgHeight = +svg.attr("height");
      const margin = { top: 50, right: 50, bottom: 50, left: 50 };
      const width = svgWidth - margin.left - margin.right;
      const height = svgHeight - margin.top - margin.bottom;
      
      // Default axes variables
      let xVar = "SolarIrradiance";
      let yVar = "Temperature";
      
      // Scales
      const xScale = d3.scaleLinear()
        .domain(d3.extent(climateData, d => d[xVar])).nice()
        .range([margin.left, margin.left + width]);
      
      const yScale = d3.scaleLinear()
        .domain(d3.extent(climateData, d => d[yVar])).nice()
        .range([margin.top + height, margin.top]);
      
      // Axes groups
      const xAxisGroup = svg.append("g")
        .attr("transform", `translate(0, ${margin.top + height})`);
      const yAxisGroup = svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`);
      
      // Axis labels
      const xLabel = svg.append("text")
        .attr("text-anchor", "middle")
        .attr("x", margin.left + width / 2)
        .attr("y", margin.top + height + 40)
        .text(xVar);
      
      const yLabel = svg.append("text")
        .attr("text-anchor", "middle")
        .attr("transform", `translate(${margin.left - 30}, ${margin.top + height / 2}) rotate(-90)`)
        .text(yVar);
      
      // Data points group
      const pointsGroup = svg.append("g").attr("class", "points-group");
      
      // Function to update the chart based on control selections
      function updateClimateChart() {
        xVar = document.getElementById("climate-factor").value;
        yVar = document.querySelector('input[name="climate-y"]:checked').value;
        
        xScale.domain(d3.extent(climateData, d => d[xVar])).nice();
        yScale.domain(d3.extent(climateData, d => d[yVar])).nice();
        
        xAxisGroup.transition().duration(750).call(d3.axisBottom(xScale));
        yAxisGroup.transition().duration(750).call(d3.axisLeft(yScale));
        
        xLabel.text(xVar);
        yLabel.text(yVar);
        
        // Bind data
        const circles = pointsGroup.selectAll("circle")
          .data(climateData);
        
        circles.enter()
          .append("circle")
          .attr("cx", d => xScale(d[xVar]))
          .attr("cy", d => yScale(d[yVar]))
          .attr("r", 5)
          .attr("fill", "#3498db")
          .merge(circles)
          .transition().duration(750)
          .attr("cx", d => xScale(d[xVar]))
          .attr("cy", d => yScale(d[yVar]));
        
        circles.exit().remove();
      }
      
      updateClimateChart();
      document.getElementById("climate-factor").addEventListener("change", updateClimateChart);
      d3.selectAll('input[name="climate-y"]').on("change", updateClimateChart);
    }
    
    /***** 2. AGRICULTURE ANALYSIS: DUAL-AXIS LINE CHART *****/
    function drawAgricultureChart() {
      const svg = d3.select("#agriculture-chart");
      const svgWidth = +svg.attr("width");
      const svgHeight = +svg.attr("height");
      const margin = { top: 50, right: 70, bottom: 50, left: 70 };
      const width = svgWidth - margin.left - margin.right;
      const height = svgHeight - margin.top - margin.bottom;
      
      // Determine overall year range using crop and co2 data
      const cropYears = cropData.map(d => d.year);
      const co2Years = co2Data.map(d => d.year);
      const allYears = cropYears.concat(co2Years);
      const yearExtent = d3.extent(allYears);
      
      const xScale = d3.scaleLinear()
        .domain(yearExtent)
        .range([margin.left, margin.left + width]);
      
      // Left axis for Crop Production
      const yScaleLeft = d3.scaleLinear()
        .domain(d3.extent(cropData, d => d.production)).nice()
        .range([margin.top + height, margin.top]);
      
      // Right axis for CO₂ Emissions
      const yScaleRight = d3.scaleLinear()
        .domain(d3.extent(co2Data, d => d.co2)).nice()
        .range([margin.top + height, margin.top]);
      
      // Axes
      svg.append("g")
        .attr("transform", `translate(0, ${margin.top + height})`)
        .call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
      
      svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(yScaleLeft).ticks(6))
        .append("text")
        .attr("fill", "#000")
        .attr("transform", "rotate(-90)")
        .attr("y", -50)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
        .text("Crop Production (t)");
      
      svg.append("g")
        .attr("transform", `translate(${margin.left + width}, 0)`)
        .call(d3.axisRight(yScaleRight).ticks(6))
        .append("text")
        .attr("fill", "#000")
        .attr("transform", "rotate(90)")
        .attr("y", -40)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
        .text("CO₂ Emissions (t)");
      
      // Line generator for crop production
      const lineCrop = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScaleLeft(d.production));
      
      // Line generator for CO₂ emissions
      const lineCO2 = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScaleRight(d.co2));
      
      // Sort data by year
      cropData.sort((a,b) => a.year - b.year);
      co2Data.sort((a,b) => a.year - b.year);
      
      // Draw lines
      svg.append("path")
        .datum(cropData)
        .attr("fill", "none")
        .attr("stroke", "#2980b9")
        .attr("stroke-width", 2)
        .attr("d", lineCrop);
      
      svg.append("path")
        .datum(co2Data)
        .attr("fill", "none")
        .attr("stroke", "#8e44ad")
        .attr("stroke-width", 2)
        .attr("d", lineCO2);
      
      // Optionally, add circles for data points on both lines
      svg.selectAll(".dotCrop")
        .data(cropData)
        .enter()
        .append("circle")
        .attr("class", "dotCrop")
        .attr("cx", d => xScale(d.year))
        .attr("cy", d => yScaleLeft(d.production))
        .attr("r", 4)
        .attr("fill", "#2980b9");
      
      svg.selectAll(".dotCO2")
        .data(co2Data)
        .enter()
        .append("circle")
        .attr("class", "dotCO2")
        .attr("cx", d => xScale(d.year))
        .attr("cy", d => yScaleRight(d.co2))
        .attr("r", 4)
        .attr("fill", "#8e44ad");
    }
    
    /***** 3. TIMELINE ANALYSIS: NORMALIZED TRENDS (ONLY IF COMMON YEARS EXIST) *****/
    function drawTimelineChart() {
      // Find common years among climate, crop, and CO₂ datasets
      const climateYears = new Set(climateData.map(d => d.Year));
      const cropYears = new Set(cropData.map(d => d.year));
      const co2Years = new Set(co2Data.map(d => d.year));
      const commonYears = Array.from(climateYears).filter(y => cropYears.has(y) && co2Years.has(y)).sort((a, b) => a - b);
      
      if(commonYears.length === 0) {
        d3.select("#timeline-msg").text("No common years found among all datasets for timeline analysis.");
        return;
      }
      
      // Merge data for the common years
      const combinedData = commonYears.map(year => {
        const climateRow = climateData.find(d => d.Year === year);
        const cropRow = cropData.find(d => d.year === year);
        const co2Row = co2Data.find(d => d.year === year);
        return {
          year: year,
          Temperature: climateRow ? climateRow.Temperature : null,
          VegetationIndex: climateRow ? climateRow.VegetationIndex : null,
          production: cropRow ? cropRow.production : null,
          co2: co2Row ? co2Row.co2 : null
        };
      });
      
      // Normalize each variable to [0,1]
      function normalize(key) {
        const values = combinedData.map(d => d[key]);
        const minVal = d3.min(values);
        const maxVal = d3.max(values);
        combinedData.forEach(d => {
          d["norm_" + key] = (d[key] - minVal) / (maxVal - minVal);
        });
      }
      normalize("Temperature");
      normalize("VegetationIndex");
      normalize("production");
      normalize("co2");
      
      const svg = d3.select("#timeline-chart");
      const svgWidth = +svg.attr("width");
      const svgHeight = +svg.attr("height");
      const margin = { top: 50, right: 100, bottom: 50, left: 50 };
      const width = svgWidth - margin.left - margin.right;
      const height = svgHeight - margin.top - margin.bottom;
      
      const xScale = d3.scaleLinear()
        .domain(d3.extent(combinedData, d => d.year))
        .range([margin.left, margin.left + width]);
      
      const yScale = d3.scaleLinear()
        .domain([0, 1])
        .range([margin.top + height, margin.top]);
      
      // Axes
      svg.append("g")
        .attr("transform", `translate(0, ${margin.top + height})`)
        .call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
      svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(yScale).ticks(5));
      
      // Line generator
      const lineGen = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScale(d.value));
      
      const series = [
        { name: "Temperature", key: "norm_Temperature", color: "#e74c3c" },
        { name: "Vegetation Index", key: "norm_VegetationIndex", color: "#27ae60" },
        { name: "Crop Production", key: "norm_production", color: "#2980b9" },
        { name: "CO₂ Emissions", key: "norm_co2", color: "#8e44ad" }
      ];
      
      series.forEach(s => {
        const lineData = combinedData.map(d => ({ year: d.year, value: d[s.key] }));
        svg.append("path")
          .datum(lineData)
          .attr("fill", "none")
          .attr("stroke", s.color)
          .attr("stroke-width", 2)
          .attr("d", lineGen);
      });
      
      // Legend
      const legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${margin.left + width + 20}, ${margin.top})`);
      
      series.forEach((s, i) => {
        const legendItem = legend.append("g")
          .attr("transform", `translate(0, ${i * 20})`);
        legendItem.append("rect")
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", s.color);
        legendItem.append("text")
          .attr("x", 16)
          .attr("y", 10)
          .text(s.name);
      });
    }
  </script>
</body>
</html>
